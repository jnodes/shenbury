<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHEN Token Presale | Shenbury 神堡</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- TronWeb -->
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.3.2/dist/TronWeb.js"></script>
    
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Cormorant Garamond', serif;
            background: #fafafa;
            color: #333;
            line-height: 1.5;
            font-size: 16px;
        }
        
        /* Loading screen */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF0013;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header styles */
        header {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            cursor: pointer;
        }
        
        .logo-text {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        
        .logo-chinese {
            font-size: 1.5rem;
            font-weight: 500;
            color: #FF0013;
        }
        
        .logo-english {
            font-size: 1.25rem;
            font-weight: 400;
        }
        
        .logo-tagline {
            font-size: 0.75rem;
            color: #666;
            font-style: italic;
            margin-top: 0.25rem;
        }
        
        .nav-center {
            display: flex;
            gap: 2rem;
        }
        
        .nav-center a {
            text-decoration: none;
            color: #666;
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        
        .nav-center a:hover,
        .nav-center a.active {
            color: #FF0013;
        }
        
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .wallet-balance {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #666;
        }
        
        .balance-item {
            padding: 0.5rem 1rem;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .connect-wallet {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #FF0013 0%, #cc000f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(255, 0, 19, 0.3);
        }
        
        .connect-wallet::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            transition: all 0.6s;
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }
        
        .connect-wallet:hover {
            background: linear-gradient(135deg, #e60012 0%, #b3000d 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 0, 19, 0.4);
        }
        
        .connect-wallet:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 0, 19, 0.3);
        }
        
        .tron-logo {
            animation: tron-pulse 2s ease-in-out infinite;
            z-index: 1;
        }
        
        @keyframes tron-pulse {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.1) rotate(5deg);
            }
            50% {
                transform: scale(1) rotate(0deg);
            }
            75% {
                transform: scale(1.1) rotate(-5deg);
            }
        }
        
        .connect-wallet span {
            position: relative;
            z-index: 1;
        }
        
        /* Additional glow effect when wallet is connected */
        .connect-wallet.connected {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
        }
        
        .connect-wallet.connected:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
        }
        
        /* Hero section */
        .presale-hero {
            background: linear-gradient(135deg, #FF0013 0%, #cc000f 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
        }
        
        .presale-hero-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .presale-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .presale-hero h1 {
            font-size: 2rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .presale-hero p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .network-info {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .network-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        /* Live indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #90EE90;
        }
        
        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #90EE90;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Countdown section */
        .countdown-section {
            background: white;
            padding: 1.5rem 1rem;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .countdown-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        
        .countdown-title {
            font-size: 1.25rem;
            font-weight: 400;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .countdown {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }
        
        .countdown-item {
            text-align: center;
        }
        
        .countdown-value {
            display: block;
            font-size: 2rem;
            font-weight: 500;
            color: #FF0013;
            line-height: 1;
        }
        
        .countdown-label {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        /* Stats section */
        .presale-stats {
            padding: 2rem 1rem;
            background: #fafafa;
        }
        
        .stats-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 32px;
        }
        
        .stat-icon svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Progress section */
        .presale-progress {
            background: white;
            padding: 2rem 1rem;
            border-top: 1px solid #e5e5e5;
        }
        
        .progress-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .progress-title {
            font-size: 1.5rem;
            font-weight: 400;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .stage-progress {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0 2rem;
            position: relative;
        }
        
        .stage-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e5e5e5;
            z-index: 0;
        }
        
        .stage-item {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }
        
        .stage-dot {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .stage-item.active .stage-dot {
            background: #FF0013;
            color: white;
            border-color: #FF0013;
            transform: scale(1.1);
        }
        
        .stage-item.completed .stage-dot {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .stage-price {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .stage-bonus {
            font-size: 0.75rem;
            color: #666;
        }
        
        .progress-bar-container {
            background: #f0f0f0;
            height: 16px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FF0013 0%, #ff3333 100%);
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Buy section */
        .buy-section {
            background: #f8f8f8;
            padding: 2rem 1rem;
        }
        
        .buy-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .buy-title {
            font-size: 1.5rem;
            font-weight: 400;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .price-info {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .price-stage {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .price-current {
            font-size: 1.75rem;
            font-weight: 500;
            color: #FF0013;
            margin-bottom: 0.25rem;
        }
        
        .price-next {
            font-size: 0.75rem;
            color: #666;
        }
        
        .buy-form {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }
        
        .input-group:focus-within {
            border-color: #FF0013;
        }
        
        .form-input {
            flex: 1;
            padding: 0.75rem;
            border: none;
            font-size: 1rem;
            outline: none;
        }
        
        .currency-selector {
            padding: 0.75rem;
            background: #f5f5f5;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .quick-amounts {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .quick-amount {
            flex: 1;
            padding: 0.5rem;
            background: #f5f5f5;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .quick-amount:hover {
            background: #FF0013;
            color: white;
            border-color: #FF0013;
        }
        
        .conversion-info {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .conversion-value {
            font-size: 1.25rem;
            font-weight: 500;
            color: #333;
            margin: 0.25rem 0;
        }
        
        .buy-button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #FF0013 0%, #cc000f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.125rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 0, 19, 0.3);
        }
        
        .buy-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.2),
                transparent
            );
            transition: left 0.5s;
        }
        
        .buy-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #e60012 0%, #b3000d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 19, 0.4);
        }
        
        .buy-button:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .buy-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 0, 19, 0.3);
        }
        
        .buy-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #ccc;
            box-shadow: none;
        }
        
        .buy-button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        /* Contract info */
        .contract-info {
            background: #f0f0f0;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-top: 2rem;
            word-break: break-all;
        }
        
        /* Exchange section */
        .exchange-section {
            background: white;
            padding: 2rem 1rem;
            border-top: 1px solid #e5e5e5;
        }
        
        .exchange-container {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        
        .exchange-container h2 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 0.5rem;
        }
        
        .exchange-container p {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 1.5rem;
        }
        
        .exchange-box {
            background: #f8f8f8;
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .exchange-input-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .exchange-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            font-size: 1.25rem;
            text-align: center;
            outline: none;
        }
        
        .exchange-input:focus {
            border-color: #FF0013;
        }
        
        .exchange-arrow {
            font-size: 1.5rem;
            color: #666;
        }
        
        .exchange-rate {
            font-size: 0.875rem;
            color: #666;
            margin: 1rem 0;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: #333;
            color: white;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 400px;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success {
            background: #28a745;
        }
        
        .toast.error {
            background: #dc3545;
        }
        
        .toast.warning {
            background: #ffc107;
            color: #333;
        }
        
        /* Data loading state */
        .data-loading {
            color: #666;
            font-style: italic;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            nav {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .nav-center {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .presale-hero h1 {
                font-size: 2rem;
            }
            
            .countdown {
                gap: 1rem;
            }
            
            .countdown-value {
                font-size: 2rem;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .stage-progress {
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .stage-item {
                flex: 0 0 45%;
            }
            
            .quick-amounts {
                flex-wrap: wrap;
            }
            
            .quick-amount {
                flex: 0 0 48%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loader"></div>
    </div>

    <!-- 
    IMPORTANT: Backend Setup Required
    
    This page requires a backend proxy to fetch TRX prices due to CORS restrictions.
    You'll need to create an endpoint at /api/trx-price that fetches from:
    - CoinGecko: https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd
    - Or Binance: https://api.binance.com/api/v3/ticker/price?symbol=TRXUSDT
    
    Example response format: { "price": 0.14 }
    -->
    
    <!-- Header -->
    <header>
        <nav>
            <div class="logo" onclick="window.location.href='/'">
                <div class="logo-text">
                    <div class="logo-chinese">神堡</div>
                    <div class="logo-english">Shenbury</div>
                </div>
                <div class="logo-tagline">The Art of Provenance</div>
            </div>
            <div class="nav-center">
                <a href="/">Collection</a>
                <a href="/presale.html" class="active">Presale</a>
                <a href="#exchange">Exchange</a>
                <a href="#about">About</a>
            </div>
            <div class="nav-right">
                <div class="wallet-info">
                    <div class="wallet-balance" id="wallet-balance" style="display: none;">
                        <div class="balance-item">
                            <span id="trx-balance">0</span> TRX
                        </div>
                        <div class="balance-item">
                            <span id="shen-balance">0</span> SHEN
                        </div>
                    </div>
                    <button class="connect-wallet" onclick="connectWallet()">
                        <svg class="tron-logo" viewBox="0 0 64 64" fill="currentColor" style="width: 16px; height: 16px;">
                            <path d="M61.55 19.28c-3-2.77-7.15-7-10.53-10.53l-2.3-2.39a7.75 7.75 0 00-11.34.36L3.86 43.16a4.69 4.69 0 00.69 7l11.5 9c.21.15.33.24.42.24s.18-.06.33-.21l42.41-37.11a5.4 5.4 0 001.34-2.8z"/>
                        </svg>
                        <span id="wallet-text">Connect TronLink</span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Presale Hero -->
    <section class="presale-hero">
        <div class="presale-hero-content">
            <div class="presale-badge">🔥 Presale Live Now</div>
            <h1>SHEN Token Presale</h1>
            <p>Join the revolution in Chinese art collecting. Get early access to SHEN tokens with up to 30% bonus.</p>
            <div class="network-info">
                <div class="network-badge">
                    <svg width="20" height="20" viewBox="0 0 64 64" fill="currentColor">
                        <path d="M61.55 19.28c-3-2.77-7.15-7-10.53-10.53l-2.3-2.39a7.75 7.75 0 00-11.34.36L3.86 43.16a4.69 4.69 0 00.69 7l11.5 9c.21.15.33.24.42.24s.18-.06.33-.21l42.41-37.11a5.4 5.4 0 001.34-2.8z"/>
                    </svg>
                    <span>TRON Network</span>
                </div>
                <div class="network-badge">TRC20 Standard</div>
                <span class="live-indicator">Live Data</span>
            </div>
        </div>
    </section>

    <!-- Countdown Timer -->
    <section class="countdown-section">
        <div class="countdown-container">
            <h2 class="countdown-title">Current Stage Ends In</h2>
            <div class="countdown" id="countdown">
                <div class="countdown-item">
                    <span class="countdown-value" id="days">--</span>
                    <span class="countdown-label">Days</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-value" id="hours">--</span>
                    <span class="countdown-label">Hours</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-value" id="minutes">--</span>
                    <span class="countdown-label">Minutes</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-value" id="seconds">--</span>
                    <span class="countdown-label">Seconds</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Presale Stats -->
    <section class="presale-stats">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">💰</div>
                <div class="stat-value" id="total-raised">
                    <span class="data-loading">Loading...</span>
                </div>
                <div class="stat-label">Total Raised (USD)</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">
                        <!-- Coin background -->
                        <circle cx="16" cy="16" r="15" fill="#FFD700"/>
                        <!-- Inner circle for depth -->
                        <circle cx="16" cy="16" r="13" fill="none" stroke="#FFA500" stroke-width="0.5"/>
                        <!-- Letter S -->
                        <text x="16" y="22" font-family="Cormorant Garamond, Georgia, serif" font-size="18" font-weight="500" text-anchor="middle" fill="#8B6914">S</text>
                    </svg>
                </div>
                <div class="stat-value" id="tokens-sold-stat">
                    <span class="data-loading">Loading...</span>
                </div>
                <div class="stat-label">SHEN Sold</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-value" id="current-price">$0.10</div>
                <div class="stat-label">Current Price</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">💎</div>
                <div class="stat-value" id="current-bonus">30%</div>
                <div class="stat-label">Current Bonus</div>
            </div>
        </div>
    </section>

    <!-- Stage Progress -->
    <section class="presale-progress">
        <div class="progress-container">
            <h2 class="progress-title">Presale Stages</h2>
            <div class="stage-progress">
                <div class="stage-item active" id="stage-0">
                    <div class="stage-dot">1</div>
                    <div class="stage-price">$0.10</div>
                    <div class="stage-bonus">30% Bonus</div>
                </div>
                <div class="stage-item" id="stage-1">
                    <div class="stage-dot">2</div>
                    <div class="stage-price">$0.20</div>
                    <div class="stage-bonus">20% Bonus</div>
                </div>
                <div class="stage-item" id="stage-2">
                    <div class="stage-dot">3</div>
                    <div class="stage-price">$0.35</div>
                    <div class="stage-bonus">10% Bonus</div>
                </div>
                <div class="stage-item" id="stage-3">
                    <div class="stage-dot">4</div>
                    <div class="stage-price">$0.50</div>
                    <div class="stage-bonus">No Bonus</div>
                </div>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-info">
                <span class="progress-amount">
                    <span id="tokens-sold">0</span> / <span id="tokens-total">40,000,000</span> SHEN
                </span>
                <span class="progress-percentage" id="progress-percentage">0%</span>
            </div>
        </div>
    </section>

    <!-- Buy Section -->
    <section class="buy-section">
        <div class="buy-container">
            <h2 class="buy-title">Buy SHEN Tokens</h2>
            
            <div class="price-info">
                <div class="price-stage">Stage <span id="stage-number">1</span> - Early Supporters</div>
                <div class="price-current">$<span id="stage-price">0.10</span> per SHEN</div>
                <div class="price-next">Next stage: $<span id="next-price">0.20</span> (+<span id="price-increase">100</span>%)</div>
            </div>
            
            <form class="buy-form" onsubmit="handleBuy(event)">
                <div class="form-group">
                    <label class="form-label">Amount in TRX</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="spend-amount" 
                               placeholder="Enter TRX amount" min="100" step="any" required>
                        <div class="currency-selector">
                            <span>TRX</span>
                        </div>
                    </div>
                </div>
                
                <div class="quick-amounts">
                    <button type="button" class="quick-amount" onclick="setAmount(1000)">1,000</button>
                    <button type="button" class="quick-amount" onclick="setAmount(5000)">5,000</button>
                    <button type="button" class="quick-amount" onclick="setAmount(10000)">10,000</button>
                    <button type="button" class="quick-amount" onclick="setAmount(50000)">50,000</button>
                </div>
                
                <div class="conversion-info">
                    <div>You will receive</div>
                    <div class="conversion-value" id="token-receive">0 SHEN</div>
                    <div id="bonus-info" style="display: none;">
                        <span style="color: #FF0013;">+<span id="bonus-amount">0</span> bonus tokens!</span>
                    </div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem;">
                        1 TRX = $<span id="trx-price">0.14</span>
                    </div>
                    <div id="validation-info" style="font-size: 0.75rem; margin-top: 0.5rem; color: #666;">
                        <!-- Validation messages will appear here -->
                    </div>
                </div>
                
                <button type="submit" class="buy-button" id="buy-button">
                    Buy SHEN Tokens
                </button>
            </form>
            
            <div class="contract-info">
                <strong>Presale Contract:</strong><br>
                <span id="presale-address" style="font-family: monospace; font-size: 0.8rem;">
                    Not deployed yet
                </span>
            </div>
        </div>
    </section>

    <!-- Simple Exchange Section -->
    <section class="exchange-section" id="exchange">
        <div class="exchange-container">
            <h2>Quick TRX ↔ SHEN Exchange</h2>
            <p>Simple token exchange for presale participants</p>
            
            <div class="exchange-box">
                <div class="exchange-input-group">
                    <input type="number" class="exchange-input" id="exchange-trx" 
                           placeholder="0" oninput="updateExchange('trx')">
                    <span>TRX</span>
                </div>
                
                <div class="exchange-arrow">↓</div>
                
                <div class="exchange-input-group">
                    <input type="number" class="exchange-input" id="exchange-shen" 
                           placeholder="0" oninput="updateExchange('shen')">
                    <span>SHEN</span>
                </div>
                
                <div class="exchange-rate">
                    Exchange Rate: 1 SHEN = $<span id="exchange-rate">0.10</span>
                </div>
                
                <button class="buy-button" onclick="executeExchange()">
                    Exchange Now
                </button>
            </div>
        </div>
    </section>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        const CONFIG = {
            PRESALE_CONTRACT: window.location.hostname === 'localhost' 
                ? 'TVgSPg3KWq8dBhPMPQh4KQXkEPN3XfWtHg' // Testnet
                : 'TXXXXXXXXXXXXXXXXXXXXXXXXXXXXXshen', // Mainnet (to be updated)
            TOTAL_PRESALE_TOKENS: 40000000,
            MIN_PURCHASE: 100,
            UPDATE_INTERVAL: 10000, // 10 seconds
            STAGES: [
                { price: 0.10, bonus: 30 },
                { price: 0.20, bonus: 20 },
                { price: 0.35, bonus: 10 },
                { price: 0.50, bonus: 0 }
            ],
            // Using proxy endpoints to avoid CORS issues
            PRICE_FEEDS: [
                '/api/trx-price' // You'll need to set up a backend proxy for this
            ]
        };

        // State management
        const state = {
            tronWeb: null,
            userAddress: null,
            presaleContract: null,
            contractData: null,
            trxPrice: 0.14,
            isLoading: false,
            countdownInterval: null,
            updateInterval: null,
            lastUpdate: 0
        };

        // Contract ABI (simplified - add full ABI when available)
        const PRESALE_ABI = [
            {
                "name": "getCurrentStage",
                "outputs": [{"type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "totalTokensSold",
                "outputs": [{"type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "getStageEndTime",
                "inputs": [{"name": "_stage", "type": "uint256"}],
                "outputs": [{"type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "calculateTokenAmount",
                "inputs": [{"name": "_trxAmount", "type": "uint256"}],
                "outputs": [
                    {"name": "baseTokens", "type": "uint256"},
                    {"name": "bonusTokens", "type": "uint256"},
                    {"name": "totalTokens", "type": "uint256"}
                ],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "getUserContribution",
                "inputs": [{"name": "_user", "type": "address"}],
                "outputs": [{"type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "maxContributionPerWallet",
                "outputs": [{"type": "uint256"}],
                "type": "function",
                "stateMutability": "view"
            },
            {
                "name": "buyTokens",
                "type": "function",
                "stateMutability": "payable"
            }
        ];

        // Initialize application
        async function init() {
            try {
                // Check TronLink installation
                if (!window.tronWeb || !window.tronLink) {
                    console.log('TronLink not detected');
                } else {
                    await checkWalletConnection();
                }

                // Initialize contract if deployed
                if (CONFIG.PRESALE_CONTRACT !== 'TXXXXXXXXXXXXXXXXXXXXXXXXXXXXXshen') {
                    await initializeContract();
                }

                // Load all data
                await loadAllData();

                // Start intervals
                startCountdown();
                state.updateInterval = setInterval(loadAllData, CONFIG.UPDATE_INTERVAL);

                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 500);

            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize application', 'error');
            }
        }

        // Initialize contract
        async function initializeContract() {
            if (!state.tronWeb) return;

            try {
                state.presaleContract = await state.tronWeb.contract(
                    PRESALE_ABI,
                    CONFIG.PRESALE_CONTRACT
                );
                document.getElementById('presale-address').textContent = CONFIG.PRESALE_CONTRACT;
            } catch (error) {
                console.error('Contract initialization error:', error);
            }
        }

        // Check wallet connection
        async function checkWalletConnection() {
            if (window.tronWeb && window.tronWeb.ready) {
                state.tronWeb = window.tronWeb;
                state.userAddress = window.tronWeb.defaultAddress.base58;
                await updateWalletUI();
                return true;
            }
            return false;
        }

        // Connect wallet
        async function connectWallet() {
            if (!window.tronLink) {
                showToast('Please install TronLink wallet', 'error');
                window.open('https://www.tronlink.org/', '_blank');
                return;
            }

            try {
                const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
                
                if (res.code === 200) {
                    state.tronWeb = window.tronWeb;
                    state.userAddress = window.tronWeb.defaultAddress.base58;
                    await initializeContract();
                    await updateWalletUI();
                    await loadAllData();
                    showToast('Wallet connected successfully!', 'success');
                }
            } catch (error) {
                console.error('Connection error:', error);
                showToast('Failed to connect wallet', 'error');
            }
        }

        // Update wallet UI
        async function updateWalletUI() {
            if (!state.userAddress) return;

            const walletButton = document.querySelector('.connect-wallet');
            const walletText = document.getElementById('wallet-text');
            const balanceDisplay = document.getElementById('wallet-balance');

            // Update button style and address display
            walletButton.classList.add('connected');
            walletText.textContent = `${state.userAddress.slice(0, 6)}...${state.userAddress.slice(-4)}`;

            try {
                // Get TRX balance
                const trxBalance = await state.tronWeb.trx.getBalance(state.userAddress);
                document.getElementById('trx-balance').textContent = (trxBalance / 1e6).toFixed(2);

                // Get SHEN balance (if token contract exists)
                // TODO: Add SHEN token balance check when token contract is available

                balanceDisplay.style.display = 'flex';
            } catch (error) {
                console.error('Error updating wallet UI:', error);
            }
        }

        // Load all data in a single operation
        async function loadAllData() {
            // Prevent concurrent updates
            const now = Date.now();
            if (now - state.lastUpdate < 1000) return;
            state.lastUpdate = now;

            try {
                // Fetch TRX price and contract data in parallel
                const [trxPrice, contractData] = await Promise.all([
                    fetchTRXPrice(),
                    fetchContractData()
                ]);

                // Update state
                state.trxPrice = trxPrice || state.trxPrice;
                state.contractData = contractData || state.contractData;

                // Update UI
                updateUI();

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Fetch TRX price from backend proxy
        async function fetchTRXPrice() {
            try {
                // For development, use a fallback price
                // In production, this should call your backend API
                if (window.location.hostname === 'localhost') {
                    return 0.14; // Default development price
                }
                
                const response = await fetch('/api/trx-price');
                const data = await response.json();
                return data.price || 0.14;
            } catch (error) {
                console.error('Failed to fetch TRX price:', error);
                return 0.14; // Fallback price
            }
        }

        // Fetch contract data
        async function fetchContractData() {
            if (!state.presaleContract) return null;

            try {
                const [currentStage, totalSold, maxContribution] = await Promise.all([
                    state.presaleContract.getCurrentStage().call(),
                    state.presaleContract.totalTokensSold().call(),
                    state.presaleContract.maxContributionPerWallet().call()
                ]);

                const stageEndTime = await state.presaleContract.getStageEndTime(currentStage).call();

                return {
                    currentStage: parseInt(currentStage),
                    totalSold: parseInt(totalSold) / 1e18,
                    maxContribution: parseInt(maxContribution) / 1e6,
                    stageEndTime: parseInt(stageEndTime) * 1000,
                    currentPrice: CONFIG.STAGES[currentStage]?.price || 0.10,
                    stageBonus: CONFIG.STAGES[currentStage]?.bonus || 0
                };
            } catch (error) {
                console.error('Error fetching contract data:', error);
                return null;
            }
        }

        // Update UI with latest data
        function updateUI() {
            const data = state.contractData || {
                currentStage: 0,
                totalSold: 0,
                currentPrice: 0.10,
                stageBonus: 30,
                stageEndTime: Date.now() + 7 * 24 * 60 * 60 * 1000
            };

            // Update TRX price
            document.getElementById('trx-price').textContent = state.trxPrice.toFixed(4);

            // Update stats
            const totalRaised = data.totalSold * data.currentPrice;
            document.getElementById('total-raised').textContent = formatCurrency(totalRaised);
            document.getElementById('tokens-sold-stat').textContent = formatNumber(data.totalSold);
            document.getElementById('current-price').textContent = `$${data.currentPrice.toFixed(2)}`;
            document.getElementById('current-bonus').textContent = `${data.stageBonus}%`;

            // Update stage progress
            updateStageProgress(data.currentStage);

            // Update progress bar
            const percentage = (data.totalSold / CONFIG.TOTAL_PRESALE_TOKENS) * 100;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('tokens-sold').textContent = formatNumber(data.totalSold);
            document.getElementById('progress-percentage').textContent = `${percentage.toFixed(1)}%`;

            // Update buy section
            document.getElementById('stage-number').textContent = data.currentStage + 1;
            document.getElementById('stage-price').textContent = data.currentPrice.toFixed(2);

            // Update next stage info
            if (data.currentStage < 3) {
                const nextStage = CONFIG.STAGES[data.currentStage + 1];
                document.getElementById('next-price').textContent = nextStage.price.toFixed(2);
                const increase = ((nextStage.price - data.currentPrice) / data.currentPrice) * 100;
                document.getElementById('price-increase').textContent = increase.toFixed(0);
            }

            // Update exchange rate
            document.getElementById('exchange-rate').textContent = data.currentPrice.toFixed(2);
        }

        // Update stage progress visual
        function updateStageProgress(currentStage) {
            document.querySelectorAll('.stage-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index < currentStage) {
                    item.classList.add('completed');
                } else if (index === currentStage) {
                    item.classList.add('active');
                }
            });
        }

        // Countdown timer
        function startCountdown() {
            if (state.countdownInterval) clearInterval(state.countdownInterval);

            state.countdownInterval = setInterval(() => {
                const endTime = state.contractData?.stageEndTime || (Date.now() + 7 * 24 * 60 * 60 * 1000);
                const distance = endTime - Date.now();

                if (distance < 0) {
                    document.getElementById('days').textContent = '0';
                    document.getElementById('hours').textContent = '00';
                    document.getElementById('minutes').textContent = '00';
                    document.getElementById('seconds').textContent = '00';
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('days').textContent = days;
                document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
            }, 1000);
        }

        // Set amount
        function setAmount(amount) {
            document.getElementById('spend-amount').value = amount;
            updateConversion();
        }

        // Update conversion with contract validation
        async function updateConversion() {
            const trxAmount = parseFloat(document.getElementById('spend-amount').value) || 0;
            const trxAmountSun = trxAmount * 1e6;

            if (!state.presaleContract || trxAmount <= 0) {
                document.getElementById('token-receive').textContent = '0 SHEN';
                document.getElementById('bonus-info').style.display = 'none';
                document.getElementById('validation-info').textContent = '';
                return;
            }

            try {
                // Get token calculation from contract
                const result = await state.presaleContract.calculateTokenAmount(trxAmountSun).call();
                const totalTokens = parseInt(result.totalTokens) / 1e18;
                const bonusTokens = parseInt(result.bonusTokens) / 1e18;

                document.getElementById('token-receive').textContent = `${formatNumber(totalTokens)} SHEN`;

                if (bonusTokens > 0) {
                    document.getElementById('bonus-info').style.display = 'block';
                    document.getElementById('bonus-amount').textContent = formatNumber(bonusTokens);
                } else {
                    document.getElementById('bonus-info').style.display = 'none';
                }

                // Validate contribution limits
                if (state.userAddress) {
                    const [userContribution, maxContribution] = await Promise.all([
                        state.presaleContract.getUserContribution(state.userAddress).call(),
                        state.presaleContract.maxContributionPerWallet().call()
                    ]);

                    const currentContribution = parseInt(userContribution) / 1e6;
                    const maxAllowed = parseInt(maxContribution) / 1e6;
                    const remainingAllowed = maxAllowed - currentContribution;

                    if (trxAmount > remainingAllowed) {
                        document.getElementById('validation-info').textContent = 
                            `⚠️ Exceeds wallet limit. Max allowed: ${remainingAllowed.toFixed(2)} TRX`;
                        document.getElementById('validation-info').style.color = '#dc3545';
                        document.getElementById('buy-button').disabled = true;
                    } else {
                        document.getElementById('validation-info').textContent = 
                            `✓ Within wallet limit (${currentContribution.toFixed(2)} / ${maxAllowed.toFixed(2)} TRX used)`;
                        document.getElementById('validation-info').style.color = '#28a745';
                        document.getElementById('buy-button').disabled = false;
                    }
                }

            } catch (error) {
                console.error('Error calculating tokens:', error);
                // Fallback calculation
                const data = state.contractData || { currentPrice: 0.10, stageBonus: 30 };
                const usdValue = trxAmount * state.trxPrice;
                const baseTokens = usdValue / data.currentPrice;
                const bonusTokens = baseTokens * (data.stageBonus / 100);
                const totalTokens = baseTokens + bonusTokens;

                document.getElementById('token-receive').textContent = `${formatNumber(totalTokens)} SHEN`;
                
                if (data.stageBonus > 0) {
                    document.getElementById('bonus-info').style.display = 'block';
                    document.getElementById('bonus-amount').textContent = formatNumber(bonusTokens);
                }
            }
        }

        // Handle buy
        async function handleBuy(event) {
            event.preventDefault();

            if (!state.userAddress) {
                showToast('Please connect your wallet first', 'error');
                return;
            }

            if (!state.presaleContract) {
                showToast('Presale contract not available', 'error');
                return;
            }

            const trxAmount = parseFloat(document.getElementById('spend-amount').value);
            if (trxAmount < CONFIG.MIN_PURCHASE) {
                showToast(`Minimum purchase is ${CONFIG.MIN_PURCHASE} TRX`, 'error');
                return;
            }

            const buyButton = document.getElementById('buy-button');
            buyButton.disabled = true;
            buyButton.classList.add('loading');
            buyButton.textContent = '';

            try {
                // Final validation
                const trxAmountSun = trxAmount * 1e6;
                const [userContribution, maxContribution] = await Promise.all([
                    state.presaleContract.getUserContribution(state.userAddress).call(),
                    state.presaleContract.maxContributionPerWallet().call()
                ]);

                const totalContribution = parseInt(userContribution) + trxAmountSun;
                if (totalContribution > parseInt(maxContribution)) {
                    throw new Error('Purchase would exceed maximum wallet contribution limit');
                }

                // Execute purchase
                const transaction = await state.presaleContract.buyTokens().send({
                    feeLimit: 100_000_000,
                    callValue: trxAmountSun,
                    shouldPollResponse: true
                });

                if (transaction.receipt.result === 'SUCCESS') {
                    showToast('Purchase successful! SHEN tokens sent to your wallet.', 'success');
                    
                    // Reset form
                    document.getElementById('spend-amount').value = '';
                    updateConversion();
                    
                    // Refresh data
                    await loadAllData();
                    await updateWalletUI();
                } else {
                    throw new Error('Transaction failed');
                }

            } catch (error) {
                console.error('Purchase error:', error);
                let errorMessage = 'Transaction failed. Please try again.';
                
                if (error.message?.includes('wallet contribution limit')) {
                    errorMessage = 'Purchase exceeds maximum wallet limit';
                } else if (error.message?.includes('revert')) {
                    errorMessage = 'Transaction reverted. Please check your balance and try again.';
                } else if (error.message?.includes('insufficient')) {
                    errorMessage = 'Insufficient TRX balance';
                }
                
                showToast(errorMessage, 'error');
            } finally {
                buyButton.disabled = false;
                buyButton.classList.remove('loading');
                buyButton.textContent = 'Buy SHEN Tokens';
            }
        }

        // Update exchange
        function updateExchange(source) {
            const trxInput = document.getElementById('exchange-trx');
            const shenInput = document.getElementById('exchange-shen');
            const data = state.contractData || { currentPrice: 0.10 };

            if (source === 'trx') {
                const trxAmount = parseFloat(trxInput.value) || 0;
                const usdValue = trxAmount * state.trxPrice;
                const shenAmount = usdValue / data.currentPrice;
                shenInput.value = shenAmount > 0 ? shenAmount.toFixed(2) : '';
            } else {
                const shenAmount = parseFloat(shenInput.value) || 0;
                const usdValue = shenAmount * data.currentPrice;
                const trxAmount = usdValue / state.trxPrice;
                trxInput.value = trxAmount > 0 ? trxAmount.toFixed(2) : '';
            }
        }

        // Execute exchange
        async function executeExchange() {
            const trxAmount = parseFloat(document.getElementById('exchange-trx').value);
            
            if (!state.userAddress) {
                showToast('Please connect your wallet first', 'error');
                return;
            }
            
            if (!trxAmount || trxAmount < CONFIG.MIN_PURCHASE) {
                showToast(`Minimum exchange is ${CONFIG.MIN_PURCHASE} TRX`, 'error');
                return;
            }
            
            // Set the amount and trigger purchase
            document.getElementById('spend-amount').value = trxAmount;
            await updateConversion();
            await handleBuy({ preventDefault: () => {} });
        }

        // Utility functions
        function formatNumber(num, decimals = 0) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Event listeners
        document.getElementById('spend-amount')?.addEventListener('input', updateConversion);

        // Listen for TronLink events
        window.addEventListener('message', function (e) {
            if (e.data.message && e.data.message.action === 'accountsChanged') {
                location.reload();
            }
        });

        // Initialize on load
        window.addEventListener('load', init);

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (state.countdownInterval) clearInterval(state.countdownInterval);
            if (state.updateInterval) clearInterval(state.updateInterval);
        });
    </script>
</body>
</html>
